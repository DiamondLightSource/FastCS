
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Creating a FastCS Driver &#8212; FastCS 0.9.2a3 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css?v=4ae1632d" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=3fefa004" />
  
  <!-- So that users can add custom icons -->
  <script src="../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../_static/documentation_options.js?v=bfda9e4d"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=30646c52"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js?v=4a39c7ea"></script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'tutorials/static-drivers';</script>
    <script>
        DOCUMENTATION_OPTIONS.theme_version = '0.16.1';
        DOCUMENTATION_OPTIONS.theme_switcher_json_url = 'https://DiamondLightSource.github.io/FastCS/switcher.json';
        DOCUMENTATION_OPTIONS.theme_switcher_version_match = '0.9.2a3';
        DOCUMENTATION_OPTIONS.show_version_warning_banner =
            false;
        </script>
    <link rel="icon" href="../_static/fastcs.svg"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="How-to Guides" href="../how-to.html" />
    <link rel="prev" title="Installation" href="installation.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="0.9.2a3" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/fastcs.svg" class="logo__image only-light" alt=""/>
    <img src="../_static/fastcs.svg" class="logo__image only-dark pst-js-only" alt=""/>
  
  
    <p class="title logo__title">FastCS</p>
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item current active">
  <a class="nav-link nav-internal" href="../tutorials.html">
    Tutorials
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../how-to.html">
    How-to Guides
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../explanations.html">
    Explanations
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../reference.html">
    Reference
  </a>
</li>

  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
        </div>
      
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/DiamondLightSource/FastCS" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://pypi.org/project/FastCS" title="PyPI" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fas fa-cube fa-lg" aria-hidden="true"></i>
            <span class="sr-only">PyPI</span></a>
        </li>
</ul></div>
      
        <div class="navbar-item">
<div class="version-switcher__container dropdown pst-js-only">
  <button id="pst-version-switcher-button-2"
    type="button"
    class="version-switcher__button btn btn-sm dropdown-toggle"
    data-bs-toggle="dropdown"
    aria-haspopup="listbox"
    aria-controls="pst-version-switcher-list-2"
    aria-label="Version switcher list"
  >
    Choose version  <!-- this text may get changed later by javascript -->
    <span class="caret"></span>
  </button>
  <div id="pst-version-switcher-list-2"
    class="version-switcher__menu dropdown-menu list-group-flush py-0"
    role="listbox" aria-labelledby="pst-version-switcher-button-2">
    <!-- dropdown will be populated by javascript on page load -->
  </div>
</div></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
    </div>
  

  
    <button class="pst-navbar-icon sidebar-toggle secondary-toggle" aria-label="On this page">
      <span class="fa-solid fa-outdent"></span>
    </button>
  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item current active">
  <a class="nav-link nav-internal" href="../tutorials.html">
    Tutorials
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../how-to.html">
    How-to Guides
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../explanations.html">
    Explanations
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../reference.html">
    Reference
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/DiamondLightSource/FastCS" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://pypi.org/project/FastCS" title="PyPI" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fas fa-cube fa-lg" aria-hidden="true"></i>
            <span class="sr-only">PyPI</span></a>
        </li>
</ul></div>
        
          <div class="navbar-item">
<div class="version-switcher__container dropdown pst-js-only">
  <button id="pst-version-switcher-button-3"
    type="button"
    class="version-switcher__button btn btn-sm dropdown-toggle"
    data-bs-toggle="dropdown"
    aria-haspopup="listbox"
    aria-controls="pst-version-switcher-list-3"
    aria-label="Version switcher list"
  >
    Choose version  <!-- this text may get changed later by javascript -->
    <span class="caret"></span>
  </button>
  <div id="pst-version-switcher-list-3"
    class="version-switcher__menu dropdown-menu list-group-flush py-0"
    role="listbox" aria-labelledby="pst-version-switcher-button-3">
    <!-- dropdown will be populated by javascript on page load -->
  </div>
</div></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
<nav class="bd-docs-nav bd-links"
     aria-label="Section Navigation">
  <p class="bd-links__title" role="heading" aria-level="1">Section Navigation</p>
  <div class="bd-toc-item navbar-nav"><ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="dynamic-drivers.html">Dynamic FastCS drivers</a></li>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Creating a FastCS Driver</a></li>
</ul>
</div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../tutorials.html" class="nav-link">Tutorials</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">Creating a FastCS Driver</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="creating-a-fastcs-driver">
<h1>Creating a FastCS Driver<a class="headerlink" href="#creating-a-fastcs-driver" title="Link to this heading">#</a></h1>
<section id="demo-simulation">
<h2>Demo Simulation<a class="headerlink" href="#demo-simulation" title="Link to this heading">#</a></h2>
<p>Within FastCS there is a tickit simulation of a temperature controller. Clone the FastCS
repository and open it in VS Code. The simulation can be run with the
<code class="docutils literal notranslate"><span class="pre">Temp</span> <span class="pre">Controller</span> <span class="pre">Sim</span></code> launch config by typing <code class="docutils literal notranslate"><span class="pre">Ctrl+P</span> <span class="pre">debug</span> </code> (note the trailing
whitespace), selecting the launch config and pressing enter. The simulation will then
sit and wait for commands to be sent. When it receives commands, it will log them to the
console to show what it is doing.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>FastCS must be installed with the <code class="docutils literal notranslate"><span class="pre">demo</span></code> extra for the demo simulator to run. This can
be done by running <code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">install</span> <span class="pre">'fastcs[demo]'</span></code>.</p>
</div>
<p>This tutorial will walk through the steps of writing a device driver to control this
simulation.</p>
</section>
<section id="fastcs-controllers">
<h2>FastCS Controllers<a class="headerlink" href="#fastcs-controllers" title="Link to this heading">#</a></h2>
<p>The core of a FastCS device driver is the <code class="docutils literal notranslate"><span class="pre">Controller</span></code>. This class is used to implement
control of a device and instances can be loaded into a FastCS application to expose its
functionality.</p>
<p>Create a <code class="docutils literal notranslate"><span class="pre">TemperatureController</span></code> class that inherits from <code class="docutils literal notranslate"><span class="pre">Controller</span></code>.</p>
<div class="dropdown hint admonition">
<p class="admonition-title">Code 1</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">fastcs.controller</span><span class="w"> </span><span class="kn">import</span> <span class="n">Controller</span>


<span class="k">class</span><span class="w"> </span><span class="nc">TemperatureController</span><span class="p">(</span><span class="n">Controller</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></div>
</div>
</div>
</section>
<section id="fastcs-launcher">
<h2>FastCS Launcher<a class="headerlink" href="#fastcs-launcher" title="Link to this heading">#</a></h2>
<p>The entrypoint to a FastCS application is the <code class="docutils literal notranslate"><span class="pre">FastCS</span></code> class. This takes a <code class="docutils literal notranslate"><span class="pre">Controller</span></code>
and a list of transports to expose the API through and provides a <code class="docutils literal notranslate"><span class="pre">run</span></code> method to launch
the application. Create a <code class="docutils literal notranslate"><span class="pre">FastCS</span></code> instance, pass the <code class="docutils literal notranslate"><span class="pre">TemperatureController</span></code> to it
along with an empty list of transports (for now).</p>
<div class="dropdown hint admonition">
<p class="admonition-title">Code 2</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">fastcs.controller</span><span class="w"> </span><span class="kn">import</span> <span class="n">Controller</span>
<span class="hll"><span class="kn">from</span><span class="w"> </span><span class="nn">fastcs.launch</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastCS</span>
</span>

<span class="k">class</span><span class="w"> </span><span class="nc">TemperatureController</span><span class="p">(</span><span class="n">Controller</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="hll"><span class="n">fastcs</span> <span class="o">=</span> <span class="n">FastCS</span><span class="p">(</span><span class="n">TemperatureController</span><span class="p">(),</span> <span class="p">[])</span>
</span><span class="hll"><span class="n">fastcs</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</span></pre></div>
</div>
</div>
<p>Now the application runs, but it still doesn’t expose any API because the <code class="docutils literal notranslate"><span class="pre">Controller</span></code>
is empty. It also completes immediately.</p>
</section>
<section id="fastcs-attributes">
<h2>FastCS Attributes<a class="headerlink" href="#fastcs-attributes" title="Link to this heading">#</a></h2>
<p>The simulator has an API to get its ID. To expose this in the driver, an <code class="docutils literal notranslate"><span class="pre">Attribute</span></code> can
be added to the <code class="docutils literal notranslate"><span class="pre">Controller</span></code>. There are 3 types of <code class="docutils literal notranslate"><span class="pre">Attribute</span></code>: <code class="docutils literal notranslate"><span class="pre">AttrR</span></code>, <code class="docutils literal notranslate"><span class="pre">AttrW</span></code> and
<code class="docutils literal notranslate"><span class="pre">AttrRW</span></code>, representing the access mode of the API. The ID can be read, but it cannot be
written, so add an <code class="docutils literal notranslate"><span class="pre">AttrR</span></code>. An <code class="docutils literal notranslate"><span class="pre">Attribute</span></code> also needs a type. The ID from the simulator
is a string, so <code class="docutils literal notranslate"><span class="pre">String</span></code> should be used.</p>
<div class="dropdown hint admonition">
<p class="admonition-title">Code 3</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="hll"><span class="kn">from</span><span class="w"> </span><span class="nn">fastcs.attributes</span><span class="w"> </span><span class="kn">import</span> <span class="n">AttrR</span>
</span><span class="kn">from</span><span class="w"> </span><span class="nn">fastcs.controller</span><span class="w"> </span><span class="kn">import</span> <span class="n">Controller</span>
<span class="hll"><span class="kn">from</span><span class="w"> </span><span class="nn">fastcs.datatypes</span><span class="w"> </span><span class="kn">import</span> <span class="n">String</span>
</span><span class="kn">from</span><span class="w"> </span><span class="nn">fastcs.launch</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastCS</span>


<span class="k">class</span><span class="w"> </span><span class="nc">TemperatureController</span><span class="p">(</span><span class="n">Controller</span><span class="p">):</span>
<span class="hll">    <span class="n">device_id</span> <span class="o">=</span> <span class="n">AttrR</span><span class="p">(</span><span class="n">String</span><span class="p">())</span>
</span>

<span class="n">fastcs</span> <span class="o">=</span> <span class="n">FastCS</span><span class="p">(</span><span class="n">TemperatureController</span><span class="p">(),</span> <span class="p">[])</span>
<span class="n">fastcs</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
</div>
<p>Now the controller has a property that will appear in the API, but the application still
completes immediately because there are no transports being run on the event loop to
expose an API.</p>
</section>
<section id="fastcs-transports">
<h2>FastCS Transports<a class="headerlink" href="#fastcs-transports" title="Link to this heading">#</a></h2>
<p>FastCS supports multiple transports to expose the API of the loaded <code class="docutils literal notranslate"><span class="pre">Controller</span></code>. The
following transports are currently supported</p>
<ul class="simple">
<li><p>EPICS CA (using <code class="docutils literal notranslate"><span class="pre">pythonSoftIOC</span></code>)</p></li>
<li><p>EPICS PVA (using <code class="docutils literal notranslate"><span class="pre">p4p</span></code>)</p></li>
<li><p>Tango (using <code class="docutils literal notranslate"><span class="pre">pytango</span></code>)</p></li>
<li><p>GraphQL (using <code class="docutils literal notranslate"><span class="pre">strawberry</span></code>)</p></li>
<li><p>HTTP (using <code class="docutils literal notranslate"><span class="pre">fastapi</span></code>)</p></li>
</ul>
<p>One or more of these can be loaded into the application and run in parallel. Add the
EPICS CA transport to the application by creating an <code class="docutils literal notranslate"><span class="pre">EPICSCAOptions</span></code> instance and
passing it in.</p>
<div class="dropdown hint admonition">
<p class="admonition-title">Code 4</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">fastcs.attributes</span><span class="w"> </span><span class="kn">import</span> <span class="n">AttrR</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastcs.controller</span><span class="w"> </span><span class="kn">import</span> <span class="n">Controller</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastcs.datatypes</span><span class="w"> </span><span class="kn">import</span> <span class="n">String</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastcs.launch</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastCS</span>
<span class="hll"><span class="kn">from</span><span class="w"> </span><span class="nn">fastcs.transport.epics.ca.options</span><span class="w"> </span><span class="kn">import</span> <span class="n">EpicsCAOptions</span>
</span><span class="hll"><span class="kn">from</span><span class="w"> </span><span class="nn">fastcs.transport.epics.options</span><span class="w"> </span><span class="kn">import</span> <span class="n">EpicsIOCOptions</span>
</span>

<span class="k">class</span><span class="w"> </span><span class="nc">TemperatureController</span><span class="p">(</span><span class="n">Controller</span><span class="p">):</span>
    <span class="n">device_id</span> <span class="o">=</span> <span class="n">AttrR</span><span class="p">(</span><span class="n">String</span><span class="p">())</span>


<span class="hll"><span class="n">epics_options</span> <span class="o">=</span> <span class="n">EpicsCAOptions</span><span class="p">(</span><span class="n">ca_ioc</span><span class="o">=</span><span class="n">EpicsIOCOptions</span><span class="p">(</span><span class="n">pv_prefix</span><span class="o">=</span><span class="s2">&quot;DEMO&quot;</span><span class="p">))</span>
</span><span class="hll"><span class="n">fastcs</span> <span class="o">=</span> <span class="n">FastCS</span><span class="p">(</span><span class="n">TemperatureController</span><span class="p">(),</span> <span class="p">[</span><span class="n">epics_options</span><span class="p">])</span>
</span>
<span class="c1"># fastcs.run()  # Commented as this will block</span>
</pre></div>
</div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>In the above snippet and all hereafter, the final line is commented out. This is done to
avoid blocking our unit tests - in your own code, it should remain uncommented.</p>
</div>
<p>The application will now run until it is stopped. There will also be a <code class="docutils literal notranslate"><span class="pre">DEMO:DeviceId</span></code>
PV being served by the application. However, the record is unset because the
<code class="docutils literal notranslate"><span class="pre">Controller</span></code> is not yet querying the simulator for the value.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>❯<span class="w"> </span>caget<span class="w"> </span>-S<span class="w"> </span>DEMO:DeviceId
DEMO:DeviceId
</pre></div>
</div>
<p>Now that the controller has a PV, it would be useful to open a UI. Add EPICS GUI
options to the transport options and generate a <code class="docutils literal notranslate"><span class="pre">demo.bob</span></code> file to use with Phoebus.</p>
<div class="dropdown hint admonition">
<p class="admonition-title">Code 5</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="hll"><span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastcs.attributes</span><span class="w"> </span><span class="kn">import</span> <span class="n">AttrR</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastcs.controller</span><span class="w"> </span><span class="kn">import</span> <span class="n">Controller</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastcs.datatypes</span><span class="w"> </span><span class="kn">import</span> <span class="n">String</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastcs.launch</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastCS</span>
<span class="hll"><span class="kn">from</span><span class="w"> </span><span class="nn">fastcs.transport.epics.ca.options</span><span class="w"> </span><span class="kn">import</span> <span class="n">EpicsCAOptions</span><span class="p">,</span> <span class="n">EpicsGUIOptions</span>
</span><span class="kn">from</span><span class="w"> </span><span class="nn">fastcs.transport.epics.options</span><span class="w"> </span><span class="kn">import</span> <span class="n">EpicsIOCOptions</span>


<span class="k">class</span><span class="w"> </span><span class="nc">TemperatureController</span><span class="p">(</span><span class="n">Controller</span><span class="p">):</span>
    <span class="n">device_id</span> <span class="o">=</span> <span class="n">AttrR</span><span class="p">(</span><span class="n">String</span><span class="p">())</span>


<span class="hll"><span class="n">gui_options</span> <span class="o">=</span> <span class="n">EpicsGUIOptions</span><span class="p">(</span>
</span><span class="hll">    <span class="n">output_path</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;demo.bob&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Demo Temperature Controller&quot;</span>
</span><span class="hll"><span class="p">)</span>
</span><span class="hll"><span class="n">epics_options</span> <span class="o">=</span> <span class="n">EpicsCAOptions</span><span class="p">(</span>
</span><span class="hll">    <span class="n">gui</span><span class="o">=</span><span class="n">gui_options</span><span class="p">,</span>
</span><span class="hll">    <span class="n">ca_ioc</span><span class="o">=</span><span class="n">EpicsIOCOptions</span><span class="p">(</span><span class="n">pv_prefix</span><span class="o">=</span><span class="s2">&quot;DEMO&quot;</span><span class="p">),</span>
</span><span class="hll"><span class="p">)</span>
</span><span class="n">fastcs</span> <span class="o">=</span> <span class="n">FastCS</span><span class="p">(</span><span class="n">TemperatureController</span><span class="p">(),</span> <span class="p">[</span><span class="n">epics_options</span><span class="p">])</span>

<span class="hll"><span class="n">fastcs</span><span class="o">.</span><span class="n">create_gui</span><span class="p">()</span>
</span>
<span class="c1"># fastcs.run()  # Commented as this will block</span>
</pre></div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">demo.bob</span></code> will have been created in the directory the application was run from.</p>
</section>
<section id="fastcs-device-connection">
<h2>FastCS Device Connection<a class="headerlink" href="#fastcs-device-connection" title="Link to this heading">#</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">Attributes</span></code> of a FastCS <code class="docutils literal notranslate"><span class="pre">Controller</span></code> need some IO with the device in order to get
and set values. This is implemented with handlers and connections. There are three types
of handler - <code class="docutils literal notranslate"><span class="pre">Sender</span></code>, <code class="docutils literal notranslate"><span class="pre">Updater</span></code> and <code class="docutils literal notranslate"><span class="pre">Handler</span></code> (which implements both). Generally each
driver implements its own connection logic, but there are some built in options.</p>
<p>Update the controller to create an <code class="docutils literal notranslate"><span class="pre">IPConnection</span></code> to communicate with the simulator over
TCP and implement a <code class="docutils literal notranslate"><span class="pre">connect</span></code> method that establishes the connection. The <code class="docutils literal notranslate"><span class="pre">connect</span></code>
method is called by the FastCS application at the appropriate time during start up to
ensure the connection is established before it is used.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The simulator control connection is on port 25565.</p>
</div>
<div class="dropdown hint admonition">
<p class="admonition-title">Code 6</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">fastcs.attributes</span><span class="w"> </span><span class="kn">import</span> <span class="n">AttrR</span>
<span class="hll"><span class="kn">from</span><span class="w"> </span><span class="nn">fastcs.connections</span><span class="w"> </span><span class="kn">import</span> <span class="n">IPConnection</span><span class="p">,</span> <span class="n">IPConnectionSettings</span>
</span><span class="kn">from</span><span class="w"> </span><span class="nn">fastcs.controller</span><span class="w"> </span><span class="kn">import</span> <span class="n">Controller</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastcs.datatypes</span><span class="w"> </span><span class="kn">import</span> <span class="n">String</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastcs.launch</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastCS</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastcs.transport.epics.ca.options</span><span class="w"> </span><span class="kn">import</span> <span class="n">EpicsCAOptions</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastcs.transport.epics.options</span><span class="w"> </span><span class="kn">import</span> <span class="n">EpicsGUIOptions</span><span class="p">,</span> <span class="n">EpicsIOCOptions</span>


<span class="k">class</span><span class="w"> </span><span class="nc">TemperatureController</span><span class="p">(</span><span class="n">Controller</span><span class="p">):</span>
    <span class="n">device_id</span> <span class="o">=</span> <span class="n">AttrR</span><span class="p">(</span><span class="n">String</span><span class="p">())</span>

<span class="hll">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">settings</span><span class="p">:</span> <span class="n">IPConnectionSettings</span><span class="p">):</span>
</span><span class="hll">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span class="hll">
</span><span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">_ip_settings</span> <span class="o">=</span> <span class="n">settings</span>
</span><span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="n">IPConnection</span><span class="p">()</span>
</span><span class="hll">
</span><span class="hll">    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class="hll">        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ip_settings</span><span class="p">)</span>
</span>

<span class="n">gui_options</span> <span class="o">=</span> <span class="n">EpicsGUIOptions</span><span class="p">(</span>
    <span class="n">output_path</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;demo.bob&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Demo Temperature Controller&quot;</span>
<span class="p">)</span>
<span class="n">epics_options</span> <span class="o">=</span> <span class="n">EpicsCAOptions</span><span class="p">(</span>
    <span class="n">gui</span><span class="o">=</span><span class="n">gui_options</span><span class="p">,</span>
    <span class="n">ca_ioc</span><span class="o">=</span><span class="n">EpicsIOCOptions</span><span class="p">(</span><span class="n">pv_prefix</span><span class="o">=</span><span class="s2">&quot;DEMO&quot;</span><span class="p">),</span>
<span class="p">)</span>
<span class="hll"><span class="n">connection_settings</span> <span class="o">=</span> <span class="n">IPConnectionSettings</span><span class="p">(</span><span class="s2">&quot;localhost&quot;</span><span class="p">,</span> <span class="mi">25565</span><span class="p">)</span>
</span><span class="hll"><span class="n">fastcs</span> <span class="o">=</span> <span class="n">FastCS</span><span class="p">(</span><span class="n">TemperatureController</span><span class="p">(</span><span class="n">connection_settings</span><span class="p">),</span> <span class="p">[</span><span class="n">epics_options</span><span class="p">])</span>
</span>
<span class="n">fastcs</span><span class="o">.</span><span class="n">create_gui</span><span class="p">()</span>

<span class="c1"># fastcs.run()  # Commented as this will block</span>
</pre></div>
</div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The application will now fail to connect if the demo simulation is not running.</p>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">Controller</span></code> has now established a connection with the simulator. This connection
can be passed to an <code class="docutils literal notranslate"><span class="pre">Updater</span></code> to enable it to query the device API and update the value
in the <code class="docutils literal notranslate"><span class="pre">device_id</span></code> attribute. Create an <code class="docutils literal notranslate"><span class="pre">Updater</span></code> child class and implement the method
to send a query to the device and set the value of the attribute, and then pass an
instance of the <code class="docutils literal notranslate"><span class="pre">Updater</span></code> to the <code class="docutils literal notranslate"><span class="pre">device_id</span></code> attribute.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <code class="docutils literal notranslate"><span class="pre">update_period</span></code> property tells the base class how often to call <code class="docutils literal notranslate"><span class="pre">update</span></code></p>
</div>
<div class="dropdown hint admonition">
<p class="admonition-title">Code 7</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="hll"><span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>
</span><span class="hll">
</span><span class="hll"><span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
</span><span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>

<span class="hll"><span class="kn">from</span><span class="w"> </span><span class="nn">fastcs.attributes</span><span class="w"> </span><span class="kn">import</span> <span class="n">AttrHandlerR</span><span class="p">,</span> <span class="n">AttrR</span>
</span><span class="kn">from</span><span class="w"> </span><span class="nn">fastcs.connections</span><span class="w"> </span><span class="kn">import</span> <span class="n">IPConnection</span><span class="p">,</span> <span class="n">IPConnectionSettings</span>
<span class="hll"><span class="kn">from</span><span class="w"> </span><span class="nn">fastcs.controller</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseController</span><span class="p">,</span> <span class="n">Controller</span>
</span><span class="kn">from</span><span class="w"> </span><span class="nn">fastcs.datatypes</span><span class="w"> </span><span class="kn">import</span> <span class="n">String</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastcs.launch</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastCS</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastcs.transport.epics.ca.options</span><span class="w"> </span><span class="kn">import</span> <span class="n">EpicsCAOptions</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastcs.transport.epics.options</span><span class="w"> </span><span class="kn">import</span> <span class="n">EpicsGUIOptions</span><span class="p">,</span> <span class="n">EpicsIOCOptions</span>


<span class="hll"><span class="nd">@dataclass</span>
</span><span class="hll"><span class="k">class</span><span class="w"> </span><span class="nc">IDUpdater</span><span class="p">(</span><span class="n">AttrHandlerR</span><span class="p">):</span>
</span><span class="hll">    <span class="n">update_period</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="mf">0.2</span>
</span><span class="hll">    <span class="n">_controller</span><span class="p">:</span> <span class="n">TemperatureController</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span class="hll">
</span><span class="hll">    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">initialise</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">controller</span><span class="p">:</span> <span class="n">BaseController</span><span class="p">):</span>
</span><span class="hll">        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">controller</span><span class="p">,</span> <span class="n">TemperatureController</span><span class="p">)</span>
</span><span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">_controller</span> <span class="o">=</span> <span class="n">controller</span>
</span><span class="hll">
</span><span class="hll">    <span class="nd">@property</span>
</span><span class="hll">    <span class="k">def</span><span class="w"> </span><span class="nf">controller</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TemperatureController</span><span class="p">:</span>
</span><span class="hll">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_controller</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span class="hll">            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Handler not initialised&quot;</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_controller</span>
</span><span class="hll">
</span><span class="hll">    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">:</span> <span class="n">AttrR</span><span class="p">):</span>
</span><span class="hll">        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">send_query</span><span class="p">(</span><span class="s2">&quot;ID?</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class="hll">        <span class="n">value</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">        <span class="k">await</span> <span class="n">attr</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span>

<span class="k">class</span><span class="w"> </span><span class="nc">TemperatureController</span><span class="p">(</span><span class="n">Controller</span><span class="p">):</span>
<span class="hll">    <span class="n">device_id</span> <span class="o">=</span> <span class="n">AttrR</span><span class="p">(</span><span class="n">String</span><span class="p">(),</span> <span class="n">handler</span><span class="o">=</span><span class="n">IDUpdater</span><span class="p">())</span>
</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">settings</span><span class="p">:</span> <span class="n">IPConnectionSettings</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ip_settings</span> <span class="o">=</span> <span class="n">settings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="n">IPConnection</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ip_settings</span><span class="p">)</span>


<span class="n">gui_options</span> <span class="o">=</span> <span class="n">EpicsGUIOptions</span><span class="p">(</span>
    <span class="n">output_path</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;demo.bob&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Demo Temperature Controller&quot;</span>
<span class="p">)</span>
<span class="n">epics_options</span> <span class="o">=</span> <span class="n">EpicsCAOptions</span><span class="p">(</span>
    <span class="n">gui</span><span class="o">=</span><span class="n">gui_options</span><span class="p">,</span>
    <span class="n">ca_ioc</span><span class="o">=</span><span class="n">EpicsIOCOptions</span><span class="p">(</span><span class="n">pv_prefix</span><span class="o">=</span><span class="s2">&quot;DEMO&quot;</span><span class="p">),</span>
<span class="p">)</span>
<span class="n">connection_settings</span> <span class="o">=</span> <span class="n">IPConnectionSettings</span><span class="p">(</span><span class="s2">&quot;localhost&quot;</span><span class="p">,</span> <span class="mi">25565</span><span class="p">)</span>
<span class="n">fastcs</span> <span class="o">=</span> <span class="n">FastCS</span><span class="p">(</span><span class="n">TemperatureController</span><span class="p">(</span><span class="n">connection_settings</span><span class="p">),</span> <span class="p">[</span><span class="n">epics_options</span><span class="p">])</span>

<span class="n">fastcs</span><span class="o">.</span><span class="n">create_gui</span><span class="p">()</span>

<span class="c1"># fastcs.run()  # Commented as this will block</span>
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In the <code class="docutils literal notranslate"><span class="pre">update</span></code> method, errors won’t crash the application, but it prints them to the
terminal. - <code class="docutils literal notranslate"><span class="pre">Update</span> <span class="pre">loop</span> <span class="pre">...</span> <span class="pre">stopped:</span></code></p>
</div>
<p>Now the PV will be set by reading from the simulator and the IOC has one fully
functional PV.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>❯<span class="w"> </span>caget<span class="w"> </span>-S<span class="w"> </span>DEMO:DeviceId
DEMO:DeviceId<span class="w"> </span>SIMTCONT123
</pre></div>
</div>
</section>
<section id="building-up-the-api">
<h2>Building Up The API<a class="headerlink" href="#building-up-the-api" title="Link to this heading">#</a></h2>
<p>The simulator supports many other commands, for example it reports the total power
currently being drawn with the <code class="docutils literal notranslate"><span class="pre">P</span></code> command. This can be exposed by adding another
<code class="docutils literal notranslate"><span class="pre">AttrR</span></code> with a <code class="docutils literal notranslate"><span class="pre">Float</span></code> datatype, but the <code class="docutils literal notranslate"><span class="pre">IDUpdater</span></code> only supports the <code class="docutils literal notranslate"><span class="pre">ID</span></code> command to
get the device ID. This new attribute could have its own updater, but it would be better
to create common updater that can be configured with the command to send so that they
can share the same code.</p>
<p>Modify the handler to take a <code class="docutils literal notranslate"><span class="pre">command_name</span></code> string and use it to create a new attribute
to read the power usage.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>All responses from the <code class="docutils literal notranslate"><span class="pre">IPConnection</span></code> are strings. This is fine for the <code class="docutils literal notranslate"><span class="pre">ID</span></code> command
because the value is actually a string, but for <code class="docutils literal notranslate"><span class="pre">P</span></code> the value is a float, so the
<code class="docutils literal notranslate"><span class="pre">update</span></code> methods needs to explicitly cast to the correct type. It can use
<code class="docutils literal notranslate"><span class="pre">Attribute.dtype</span></code> to call the builtin for its datatype - e.g. <code class="docutils literal notranslate"><span class="pre">int</span></code>, <code class="docutils literal notranslate"><span class="pre">float</span></code>, <code class="docutils literal notranslate"><span class="pre">str</span></code>,
etc.</p>
</div>
<div class="dropdown hint admonition">
<p class="admonition-title">Code 8</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">fastcs.attributes</span><span class="w"> </span><span class="kn">import</span> <span class="n">AttrHandlerR</span><span class="p">,</span> <span class="n">AttrR</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastcs.connections</span><span class="w"> </span><span class="kn">import</span> <span class="n">IPConnection</span><span class="p">,</span> <span class="n">IPConnectionSettings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastcs.controller</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseController</span><span class="p">,</span> <span class="n">Controller</span>
<span class="hll"><span class="kn">from</span><span class="w"> </span><span class="nn">fastcs.datatypes</span><span class="w"> </span><span class="kn">import</span> <span class="n">Float</span><span class="p">,</span> <span class="n">String</span>
</span><span class="kn">from</span><span class="w"> </span><span class="nn">fastcs.launch</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastCS</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastcs.transport.epics.ca.options</span><span class="w"> </span><span class="kn">import</span> <span class="n">EpicsCAOptions</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastcs.transport.epics.options</span><span class="w"> </span><span class="kn">import</span> <span class="n">EpicsGUIOptions</span><span class="p">,</span> <span class="n">EpicsIOCOptions</span>


<span class="nd">@dataclass</span>
<span class="hll"><span class="k">class</span><span class="w"> </span><span class="nc">TemperatureControllerUpdater</span><span class="p">(</span><span class="n">AttrHandlerR</span><span class="p">):</span>
</span><span class="hll">    <span class="n">command_name</span><span class="p">:</span> <span class="nb">str</span>
</span>    <span class="n">update_period</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="mf">0.2</span>
    <span class="n">_controller</span><span class="p">:</span> <span class="n">TemperatureController</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">initialise</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">controller</span><span class="p">:</span> <span class="n">BaseController</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">controller</span><span class="p">,</span> <span class="n">TemperatureController</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_controller</span> <span class="o">=</span> <span class="n">controller</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">controller</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TemperatureController</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_controller</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Handler not initialised&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_controller</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">:</span> <span class="n">AttrR</span><span class="p">):</span>
<span class="hll">        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">send_query</span><span class="p">(</span>
</span><span class="hll">            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">command_name</span><span class="si">}</span><span class="s2">?</span><span class="se">\r\n</span><span class="s2">&quot;</span>
</span><span class="hll">        <span class="p">)</span>
</span>        <span class="n">value</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="hll">        <span class="k">await</span> <span class="n">attr</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
</span>

<span class="k">class</span><span class="w"> </span><span class="nc">TemperatureController</span><span class="p">(</span><span class="n">Controller</span><span class="p">):</span>
<span class="hll">    <span class="n">device_id</span> <span class="o">=</span> <span class="n">AttrR</span><span class="p">(</span><span class="n">String</span><span class="p">(),</span> <span class="n">handler</span><span class="o">=</span><span class="n">TemperatureControllerUpdater</span><span class="p">(</span><span class="s2">&quot;ID&quot;</span><span class="p">))</span>
</span><span class="hll">    <span class="n">power</span> <span class="o">=</span> <span class="n">AttrR</span><span class="p">(</span><span class="n">Float</span><span class="p">(),</span> <span class="n">handler</span><span class="o">=</span><span class="n">TemperatureControllerUpdater</span><span class="p">(</span><span class="s2">&quot;P&quot;</span><span class="p">))</span>
</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">settings</span><span class="p">:</span> <span class="n">IPConnectionSettings</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ip_settings</span> <span class="o">=</span> <span class="n">settings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="n">IPConnection</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ip_settings</span><span class="p">)</span>


<span class="n">gui_options</span> <span class="o">=</span> <span class="n">EpicsGUIOptions</span><span class="p">(</span>
    <span class="n">output_path</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;demo.bob&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Demo Temperature Controller&quot;</span>
<span class="p">)</span>
<span class="n">epics_options</span> <span class="o">=</span> <span class="n">EpicsCAOptions</span><span class="p">(</span>
    <span class="n">gui</span><span class="o">=</span><span class="n">gui_options</span><span class="p">,</span>
    <span class="n">ca_ioc</span><span class="o">=</span><span class="n">EpicsIOCOptions</span><span class="p">(</span><span class="n">pv_prefix</span><span class="o">=</span><span class="s2">&quot;DEMO&quot;</span><span class="p">),</span>
<span class="p">)</span>
<span class="n">connection_settings</span> <span class="o">=</span> <span class="n">IPConnectionSettings</span><span class="p">(</span><span class="s2">&quot;localhost&quot;</span><span class="p">,</span> <span class="mi">25565</span><span class="p">)</span>
<span class="n">fastcs</span> <span class="o">=</span> <span class="n">FastCS</span><span class="p">(</span><span class="n">TemperatureController</span><span class="p">(</span><span class="n">connection_settings</span><span class="p">),</span> <span class="p">[</span><span class="n">epics_options</span><span class="p">])</span>

<span class="n">fastcs</span><span class="o">.</span><span class="n">create_gui</span><span class="p">()</span>

<span class="c1"># fastcs.run()  # Commented as this will block</span>
</pre></div>
</div>
</div>
<div class="docutils">
<p>Now the IOC has two PVs being polled periodically. The new PV will be visible in the
Phoebus UI on refresh (right-click). <code class="docutils literal notranslate"><span class="pre">DEMO:Power</span></code> will read as <code class="docutils literal notranslate"><span class="pre">0</span></code> because the simulator
is not currently running a ramp. To do that the controller needs to be able to set
values on the device, as well as read them back. The ramp rate of the temperature can be
read with the <code class="docutils literal notranslate"><span class="pre">R</span></code> command and set with the <code class="docutils literal notranslate"><span class="pre">R=...</span></code> command. This means the controller
also needs a <code class="docutils literal notranslate"><span class="pre">Sender</span></code> handler that implements <code class="docutils literal notranslate"><span class="pre">put</span></code> to send values to the device.</p>
<p>Update the existing handler to support both <code class="docutils literal notranslate"><span class="pre">update</span></code> and <code class="docutils literal notranslate"><span class="pre">put</span></code>, making it a <code class="docutils literal notranslate"><span class="pre">Handler</span></code>
(which implements both <code class="docutils literal notranslate"><span class="pre">Updater</span></code> and <code class="docutils literal notranslate"><span class="pre">Sender</span></code>). Then add a new <code class="docutils literal notranslate"><span class="pre">AttrRW</span></code> with type
<code class="docutils literal notranslate"><span class="pre">Float</span></code> to get and set the ramp rate.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The set commands do not return a response, so use the <code class="docutils literal notranslate"><span class="pre">send_command</span></code> method instead of
<code class="docutils literal notranslate"><span class="pre">send_query</span></code>.</p>
</div>
<div class="dropdown hint admonition">
<p class="admonition-title">Code 9</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="hll"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span>
</span>
<span class="hll"><span class="kn">from</span><span class="w"> </span><span class="nn">fastcs.attributes</span><span class="w"> </span><span class="kn">import</span> <span class="n">AttrHandlerRW</span><span class="p">,</span> <span class="n">AttrR</span><span class="p">,</span> <span class="n">AttrRW</span><span class="p">,</span> <span class="n">AttrW</span>
</span><span class="kn">from</span><span class="w"> </span><span class="nn">fastcs.connections</span><span class="w"> </span><span class="kn">import</span> <span class="n">IPConnection</span><span class="p">,</span> <span class="n">IPConnectionSettings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastcs.controller</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseController</span><span class="p">,</span> <span class="n">Controller</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastcs.datatypes</span><span class="w"> </span><span class="kn">import</span> <span class="n">Float</span><span class="p">,</span> <span class="n">String</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastcs.launch</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastCS</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastcs.transport.epics.ca.options</span><span class="w"> </span><span class="kn">import</span> <span class="n">EpicsCAOptions</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastcs.transport.epics.options</span><span class="w"> </span><span class="kn">import</span> <span class="n">EpicsGUIOptions</span><span class="p">,</span> <span class="n">EpicsIOCOptions</span>


<span class="nd">@dataclass</span>
<span class="hll"><span class="k">class</span><span class="w"> </span><span class="nc">TemperatureControllerHandler</span><span class="p">(</span><span class="n">AttrHandlerRW</span><span class="p">):</span>
</span>    <span class="n">command_name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">update_period</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="mf">0.2</span>
    <span class="n">_controller</span><span class="p">:</span> <span class="n">TemperatureController</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">initialise</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">controller</span><span class="p">:</span> <span class="n">BaseController</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">controller</span><span class="p">,</span> <span class="n">TemperatureController</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_controller</span> <span class="o">=</span> <span class="n">controller</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">controller</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TemperatureController</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_controller</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Handler not initialised&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_controller</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">:</span> <span class="n">AttrR</span><span class="p">):</span>
        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">send_query</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">command_name</span><span class="si">}</span><span class="s2">?</span><span class="se">\r\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">await</span> <span class="n">attr</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>

<span class="hll">    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">:</span> <span class="n">AttrW</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
</span><span class="hll">        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">send_command</span><span class="p">(</span>
</span><span class="hll">            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">command_name</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">attr</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="si">}</span><span class="se">\r\n</span><span class="s2">&quot;</span>
</span><span class="hll">        <span class="p">)</span>
</span>

<span class="k">class</span><span class="w"> </span><span class="nc">TemperatureController</span><span class="p">(</span><span class="n">Controller</span><span class="p">):</span>
<span class="hll">    <span class="n">device_id</span> <span class="o">=</span> <span class="n">AttrR</span><span class="p">(</span><span class="n">String</span><span class="p">(),</span> <span class="n">handler</span><span class="o">=</span><span class="n">TemperatureControllerHandler</span><span class="p">(</span><span class="s2">&quot;ID&quot;</span><span class="p">))</span>
</span><span class="hll">    <span class="n">power</span> <span class="o">=</span> <span class="n">AttrR</span><span class="p">(</span><span class="n">Float</span><span class="p">(),</span> <span class="n">handler</span><span class="o">=</span><span class="n">TemperatureControllerHandler</span><span class="p">(</span><span class="s2">&quot;P&quot;</span><span class="p">))</span>
</span><span class="hll">    <span class="n">ramp_rate</span> <span class="o">=</span> <span class="n">AttrRW</span><span class="p">(</span><span class="n">Float</span><span class="p">(),</span> <span class="n">handler</span><span class="o">=</span><span class="n">TemperatureControllerHandler</span><span class="p">(</span><span class="s2">&quot;R&quot;</span><span class="p">))</span>
</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">settings</span><span class="p">:</span> <span class="n">IPConnectionSettings</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ip_settings</span> <span class="o">=</span> <span class="n">settings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="n">IPConnection</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ip_settings</span><span class="p">)</span>


<span class="n">gui_options</span> <span class="o">=</span> <span class="n">EpicsGUIOptions</span><span class="p">(</span>
    <span class="n">output_path</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;demo.bob&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Demo Temperature Controller&quot;</span>
<span class="p">)</span>
<span class="n">epics_options</span> <span class="o">=</span> <span class="n">EpicsCAOptions</span><span class="p">(</span>
    <span class="n">gui</span><span class="o">=</span><span class="n">gui_options</span><span class="p">,</span>
    <span class="n">ca_ioc</span><span class="o">=</span><span class="n">EpicsIOCOptions</span><span class="p">(</span><span class="n">pv_prefix</span><span class="o">=</span><span class="s2">&quot;DEMO&quot;</span><span class="p">),</span>
<span class="p">)</span>
<span class="n">connection_settings</span> <span class="o">=</span> <span class="n">IPConnectionSettings</span><span class="p">(</span><span class="s2">&quot;localhost&quot;</span><span class="p">,</span> <span class="mi">25565</span><span class="p">)</span>
<span class="n">fastcs</span> <span class="o">=</span> <span class="n">FastCS</span><span class="p">(</span><span class="n">TemperatureController</span><span class="p">(</span><span class="n">connection_settings</span><span class="p">),</span> <span class="p">[</span><span class="n">epics_options</span><span class="p">])</span>

<span class="n">fastcs</span><span class="o">.</span><span class="n">create_gui</span><span class="p">()</span>

<span class="c1"># fastcs.run()  # Commented as this will block</span>
</pre></div>
</div>
</div>
</div>
<p>Two new PVs will be created: one to set the ramp rate and one to read it back.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>❯<span class="w"> </span>caget<span class="w"> </span>DEMO:RampRate_RBV
DEMO:RampRate_RBV<span class="w">              </span><span class="m">2</span>
❯<span class="w"> </span>caput<span class="w"> </span>DEMO:RampRate<span class="w"> </span><span class="m">5</span>
Old<span class="w"> </span>:<span class="w"> </span>DEMO:RampRate<span class="w">                  </span><span class="m">2</span>
New<span class="w"> </span>:<span class="w"> </span>DEMO:RampRate<span class="w">                  </span><span class="m">5</span>
❯<span class="w"> </span>caget<span class="w"> </span>DEMO:RampRate_RBV
DEMO:RampRate_RBV<span class="w">              </span><span class="m">5</span>
</pre></div>
</div>
<p>The changes will also be visible in the simulator terminal.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">INFO</span><span class="p">:</span><span class="n">fastcs</span><span class="o">.</span><span class="n">demo</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">device</span><span class="p">:</span><span class="n">Set</span> <span class="n">ramp</span> <span class="n">rate</span> <span class="n">to</span> <span class="mf">5.0</span>
</pre></div>
</div>
<p>This adds the first method to modify the device, but more are needed to be able to run a
temperature ramp. The simulator has multiple temperature control loops that can be
ramped independently. They each have a common set of commands that control them
individually, for example to <code class="docutils literal notranslate"><span class="pre">S01=...</span></code> to set the start point for ramp 1, <code class="docutils literal notranslate"><span class="pre">E02=...</span></code> to
set the end point for ramp 2.</p>
<p>Given that the device has <code class="docutils literal notranslate"><span class="pre">n</span></code> instances of a common interface, it makes sense to create
a class to encapsulate this control and then instantiate it for each ramp the simulator
has. This can be done with the use of sub controllers. Controllers can be arbitrarily
nested to match the structure of a device and this structure is then mirrored to the
transport layer for the visibility of the user.</p>
<p>Create a <code class="docutils literal notranslate"><span class="pre">TemperatureRampController</span></code> with <code class="docutils literal notranslate"><span class="pre">AttrRW</span></code>s to get and set the ramp start and
end, update the <code class="docutils literal notranslate"><span class="pre">TemperatureControllerHandler</span></code> to include an optional suffix for the
commands so that it can be shared between the parent <code class="docutils literal notranslate"><span class="pre">TemperatureController</span></code> and add an
argument to define how many ramps there are, which is used to register the correct
number of ramp controllers with the parent.</p>
<div class="dropdown hint admonition">
<p class="admonition-title">Code 10</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">fastcs.attributes</span><span class="w"> </span><span class="kn">import</span> <span class="n">AttrHandlerRW</span><span class="p">,</span> <span class="n">AttrR</span><span class="p">,</span> <span class="n">AttrRW</span><span class="p">,</span> <span class="n">AttrW</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastcs.connections</span><span class="w"> </span><span class="kn">import</span> <span class="n">IPConnection</span><span class="p">,</span> <span class="n">IPConnectionSettings</span>
<span class="hll"><span class="kn">from</span><span class="w"> </span><span class="nn">fastcs.controller</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseController</span><span class="p">,</span> <span class="n">Controller</span><span class="p">,</span> <span class="n">SubController</span>
</span><span class="hll"><span class="kn">from</span><span class="w"> </span><span class="nn">fastcs.datatypes</span><span class="w"> </span><span class="kn">import</span> <span class="n">Float</span><span class="p">,</span> <span class="n">Int</span><span class="p">,</span> <span class="n">String</span>
</span><span class="kn">from</span><span class="w"> </span><span class="nn">fastcs.launch</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastCS</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastcs.transport.epics.ca.options</span><span class="w"> </span><span class="kn">import</span> <span class="n">EpicsCAOptions</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastcs.transport.epics.options</span><span class="w"> </span><span class="kn">import</span> <span class="n">EpicsGUIOptions</span><span class="p">,</span> <span class="n">EpicsIOCOptions</span>


<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">TemperatureControllerHandler</span><span class="p">(</span><span class="n">AttrHandlerRW</span><span class="p">):</span>
    <span class="n">command_name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">update_period</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="mf">0.2</span>
<span class="hll">    <span class="n">_controller</span><span class="p">:</span> <span class="n">TemperatureController</span> <span class="o">|</span> <span class="n">TemperatureRampController</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">initialise</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">controller</span><span class="p">:</span> <span class="n">BaseController</span><span class="p">):</span>
<span class="hll">        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">controller</span><span class="p">,</span> <span class="n">TemperatureController</span> <span class="o">|</span> <span class="n">TemperatureRampController</span><span class="p">)</span>
</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_controller</span> <span class="o">=</span> <span class="n">controller</span>

    <span class="nd">@property</span>
<span class="hll">    <span class="k">def</span><span class="w"> </span><span class="nf">controller</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TemperatureController</span> <span class="o">|</span> <span class="n">TemperatureRampController</span><span class="p">:</span>
</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_controller</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Handler not initialised&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_controller</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">:</span> <span class="n">AttrR</span><span class="p">):</span>
        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">send_query</span><span class="p">(</span>
<span class="hll">            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">command_name</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">suffix</span><span class="si">}</span><span class="s2">?</span><span class="se">\r\n</span><span class="s2">&quot;</span>
</span>        <span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">await</span> <span class="n">attr</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">:</span> <span class="n">AttrW</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">send_command</span><span class="p">(</span>
<span class="hll">            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">command_name</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">suffix</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">attr</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="si">}</span><span class="se">\r\n</span><span class="s2">&quot;</span>
</span>        <span class="p">)</span>


<span class="hll"><span class="k">class</span><span class="w"> </span><span class="nc">TemperatureRampController</span><span class="p">(</span><span class="n">SubController</span><span class="p">):</span>
</span><span class="hll">    <span class="n">start</span> <span class="o">=</span> <span class="n">AttrRW</span><span class="p">(</span><span class="n">Int</span><span class="p">(),</span> <span class="n">handler</span><span class="o">=</span><span class="n">TemperatureControllerHandler</span><span class="p">(</span><span class="s2">&quot;S&quot;</span><span class="p">))</span>
</span><span class="hll">    <span class="n">end</span> <span class="o">=</span> <span class="n">AttrRW</span><span class="p">(</span><span class="n">Int</span><span class="p">(),</span> <span class="n">handler</span><span class="o">=</span><span class="n">TemperatureControllerHandler</span><span class="p">(</span><span class="s2">&quot;E&quot;</span><span class="p">))</span>
</span><span class="hll">
</span><span class="hll">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">connection</span><span class="p">:</span> <span class="n">IPConnection</span><span class="p">):</span>
</span><span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">index</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class="hll">
</span><span class="hll">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Ramp</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="n">connection</span>
</span>

<span class="k">class</span><span class="w"> </span><span class="nc">TemperatureController</span><span class="p">(</span><span class="n">Controller</span><span class="p">):</span>
    <span class="n">device_id</span> <span class="o">=</span> <span class="n">AttrR</span><span class="p">(</span><span class="n">String</span><span class="p">(),</span> <span class="n">handler</span><span class="o">=</span><span class="n">TemperatureControllerHandler</span><span class="p">(</span><span class="s2">&quot;ID&quot;</span><span class="p">))</span>
    <span class="n">power</span> <span class="o">=</span> <span class="n">AttrR</span><span class="p">(</span><span class="n">Float</span><span class="p">(),</span> <span class="n">handler</span><span class="o">=</span><span class="n">TemperatureControllerHandler</span><span class="p">(</span><span class="s2">&quot;P&quot;</span><span class="p">))</span>
    <span class="n">ramp_rate</span> <span class="o">=</span> <span class="n">AttrRW</span><span class="p">(</span><span class="n">Float</span><span class="p">(),</span> <span class="n">handler</span><span class="o">=</span><span class="n">TemperatureControllerHandler</span><span class="p">(</span><span class="s2">&quot;R&quot;</span><span class="p">))</span>

<span class="hll">    <span class="n">suffix</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span>
<span class="hll">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ramp_count</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">settings</span><span class="p">:</span> <span class="n">IPConnectionSettings</span><span class="p">):</span>
</span>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ip_settings</span> <span class="o">=</span> <span class="n">settings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="n">IPConnection</span><span class="p">()</span>

<span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">_ramp_controllers</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">TemperatureRampController</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span class="hll">        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ramp_count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
</span><span class="hll">            <span class="n">ramp_controller</span> <span class="o">=</span> <span class="n">TemperatureRampController</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="p">)</span>
</span><span class="hll">            <span class="bp">self</span><span class="o">.</span><span class="n">_ramp_controllers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ramp_controller</span><span class="p">)</span>
</span><span class="hll">            <span class="bp">self</span><span class="o">.</span><span class="n">register_sub_controller</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;R</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ramp_controller</span><span class="p">)</span>
</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ip_settings</span><span class="p">)</span>


<span class="n">gui_options</span> <span class="o">=</span> <span class="n">EpicsGUIOptions</span><span class="p">(</span>
    <span class="n">output_path</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;demo.bob&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Demo Temperature Controller&quot;</span>
<span class="p">)</span>
<span class="n">epics_options</span> <span class="o">=</span> <span class="n">EpicsCAOptions</span><span class="p">(</span>
    <span class="n">gui</span><span class="o">=</span><span class="n">gui_options</span><span class="p">,</span>
    <span class="n">ca_ioc</span><span class="o">=</span><span class="n">EpicsIOCOptions</span><span class="p">(</span><span class="n">pv_prefix</span><span class="o">=</span><span class="s2">&quot;DEMO&quot;</span><span class="p">),</span>
<span class="p">)</span>
<span class="n">connection_settings</span> <span class="o">=</span> <span class="n">IPConnectionSettings</span><span class="p">(</span><span class="s2">&quot;localhost&quot;</span><span class="p">,</span> <span class="mi">25565</span><span class="p">)</span>
<span class="hll"><span class="n">fastcs</span> <span class="o">=</span> <span class="n">FastCS</span><span class="p">(</span><span class="n">TemperatureController</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">connection_settings</span><span class="p">),</span> <span class="p">[</span><span class="n">epics_options</span><span class="p">])</span>
</span>
<span class="n">fastcs</span><span class="o">.</span><span class="n">create_gui</span><span class="p">()</span>

<span class="c1"># fastcs.run()  # Commented as this will block</span>
</pre></div>
</div>
</div>
<p>New PVs will be added (e.g. <code class="docutils literal notranslate"><span class="pre">DEMO:R1:Start</span></code>):</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">DEMO:R{1,2,3,4}:Start</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">DEMO:R{1,2,3,4}:Start_RBV</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">DEMO:R{1,2,3,4}:End</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">DEMO:R{1,2,3,4}:End_RBV</span></code></p></li>
</ul>
<p>Four buttons will also be added to the Phoebus UI to open sub screens for each ramp.</p>
<p>This allows the controller to set the range of every temperature ramp. Again, the
simulator terminal will confirm that the changes are taking effect. The final commands
needed to run a temperature ramp are the <code class="docutils literal notranslate"><span class="pre">N01</span></code> and <code class="docutils literal notranslate"><span class="pre">N01=</span></code> commands, which are used to
enable (and disable) the ramping.</p>
<p>Add an <code class="docutils literal notranslate"><span class="pre">AttrRW</span></code> to the <code class="docutils literal notranslate"><span class="pre">TemperatureRampController</span></code>s with an <code class="docutils literal notranslate"><span class="pre">Enum</span></code> type, using a
<code class="docutils literal notranslate"><span class="pre">StrEnum</span></code> with states <code class="docutils literal notranslate"><span class="pre">Off</span></code> and <code class="docutils literal notranslate"><span class="pre">On</span></code>.</p>
<div class="dropdown hint admonition">
<p class="admonition-title">Code 11</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>

<span class="hll"><span class="kn">import</span><span class="w"> </span><span class="nn">enum</span>
</span><span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">fastcs.attributes</span><span class="w"> </span><span class="kn">import</span> <span class="n">AttrHandlerRW</span><span class="p">,</span> <span class="n">AttrR</span><span class="p">,</span> <span class="n">AttrRW</span><span class="p">,</span> <span class="n">AttrW</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastcs.connections</span><span class="w"> </span><span class="kn">import</span> <span class="n">IPConnection</span><span class="p">,</span> <span class="n">IPConnectionSettings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastcs.controller</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseController</span><span class="p">,</span> <span class="n">Controller</span><span class="p">,</span> <span class="n">SubController</span>
<span class="hll"><span class="kn">from</span><span class="w"> </span><span class="nn">fastcs.datatypes</span><span class="w"> </span><span class="kn">import</span> <span class="n">Enum</span><span class="p">,</span> <span class="n">Float</span><span class="p">,</span> <span class="n">Int</span><span class="p">,</span> <span class="n">String</span>
</span><span class="kn">from</span><span class="w"> </span><span class="nn">fastcs.launch</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastCS</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastcs.transport.epics.ca.options</span><span class="w"> </span><span class="kn">import</span> <span class="n">EpicsCAOptions</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastcs.transport.epics.options</span><span class="w"> </span><span class="kn">import</span> <span class="n">EpicsGUIOptions</span><span class="p">,</span> <span class="n">EpicsIOCOptions</span>


<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">TemperatureControllerHandler</span><span class="p">(</span><span class="n">AttrHandlerRW</span><span class="p">):</span>
    <span class="n">command_name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">update_period</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="mf">0.2</span>
    <span class="n">_controller</span><span class="p">:</span> <span class="n">TemperatureController</span> <span class="o">|</span> <span class="n">TemperatureRampController</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">initialise</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">controller</span><span class="p">:</span> <span class="n">BaseController</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">controller</span><span class="p">,</span> <span class="n">TemperatureController</span> <span class="o">|</span> <span class="n">TemperatureRampController</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_controller</span> <span class="o">=</span> <span class="n">controller</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">controller</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TemperatureController</span> <span class="o">|</span> <span class="n">TemperatureRampController</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_controller</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Handler not initialised&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_controller</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">:</span> <span class="n">AttrR</span><span class="p">):</span>
        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">send_query</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">command_name</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">suffix</span><span class="si">}</span><span class="s2">?</span><span class="se">\r\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">await</span> <span class="n">attr</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">:</span> <span class="n">AttrW</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">send_command</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">command_name</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">suffix</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">attr</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="si">}</span><span class="se">\r\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>


<span class="hll"><span class="k">class</span><span class="w"> </span><span class="nc">OnOffEnum</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">StrEnum</span><span class="p">):</span>
</span><span class="hll">    <span class="n">Off</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span>
</span><span class="hll">    <span class="n">On</span> <span class="o">=</span> <span class="s2">&quot;1&quot;</span>
</span>

<span class="k">class</span><span class="w"> </span><span class="nc">TemperatureRampController</span><span class="p">(</span><span class="n">SubController</span><span class="p">):</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">AttrRW</span><span class="p">(</span><span class="n">Int</span><span class="p">(),</span> <span class="n">handler</span><span class="o">=</span><span class="n">TemperatureControllerHandler</span><span class="p">(</span><span class="s2">&quot;S&quot;</span><span class="p">))</span>
    <span class="n">end</span> <span class="o">=</span> <span class="n">AttrRW</span><span class="p">(</span><span class="n">Int</span><span class="p">(),</span> <span class="n">handler</span><span class="o">=</span><span class="n">TemperatureControllerHandler</span><span class="p">(</span><span class="s2">&quot;E&quot;</span><span class="p">))</span>
<span class="hll">    <span class="n">enabled</span> <span class="o">=</span> <span class="n">AttrRW</span><span class="p">(</span><span class="n">Enum</span><span class="p">(</span><span class="n">OnOffEnum</span><span class="p">),</span> <span class="n">handler</span><span class="o">=</span><span class="n">TemperatureControllerHandler</span><span class="p">(</span><span class="s2">&quot;N&quot;</span><span class="p">))</span>
</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">connection</span><span class="p">:</span> <span class="n">IPConnection</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">index</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Ramp</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="n">connection</span>


<span class="k">class</span><span class="w"> </span><span class="nc">TemperatureController</span><span class="p">(</span><span class="n">Controller</span><span class="p">):</span>
    <span class="n">device_id</span> <span class="o">=</span> <span class="n">AttrR</span><span class="p">(</span><span class="n">String</span><span class="p">(),</span> <span class="n">handler</span><span class="o">=</span><span class="n">TemperatureControllerHandler</span><span class="p">(</span><span class="s2">&quot;ID&quot;</span><span class="p">))</span>
    <span class="n">power</span> <span class="o">=</span> <span class="n">AttrR</span><span class="p">(</span><span class="n">Float</span><span class="p">(),</span> <span class="n">handler</span><span class="o">=</span><span class="n">TemperatureControllerHandler</span><span class="p">(</span><span class="s2">&quot;P&quot;</span><span class="p">))</span>
    <span class="n">ramp_rate</span> <span class="o">=</span> <span class="n">AttrRW</span><span class="p">(</span><span class="n">Float</span><span class="p">(),</span> <span class="n">handler</span><span class="o">=</span><span class="n">TemperatureControllerHandler</span><span class="p">(</span><span class="s2">&quot;R&quot;</span><span class="p">))</span>

    <span class="n">suffix</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ramp_count</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">settings</span><span class="p">:</span> <span class="n">IPConnectionSettings</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ip_settings</span> <span class="o">=</span> <span class="n">settings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="n">IPConnection</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ramp_controllers</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">TemperatureRampController</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ramp_count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">ramp_controller</span> <span class="o">=</span> <span class="n">TemperatureRampController</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ramp_controllers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ramp_controller</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">register_sub_controller</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;R</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ramp_controller</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ip_settings</span><span class="p">)</span>


<span class="n">gui_options</span> <span class="o">=</span> <span class="n">EpicsGUIOptions</span><span class="p">(</span>
    <span class="n">output_path</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;demo.bob&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Demo Temperature Controller&quot;</span>
<span class="p">)</span>
<span class="n">epics_options</span> <span class="o">=</span> <span class="n">EpicsCAOptions</span><span class="p">(</span>
    <span class="n">gui</span><span class="o">=</span><span class="n">gui_options</span><span class="p">,</span>
    <span class="n">ca_ioc</span><span class="o">=</span><span class="n">EpicsIOCOptions</span><span class="p">(</span><span class="n">pv_prefix</span><span class="o">=</span><span class="s2">&quot;DEMO&quot;</span><span class="p">),</span>
<span class="p">)</span>
<span class="n">connection_settings</span> <span class="o">=</span> <span class="n">IPConnectionSettings</span><span class="p">(</span><span class="s2">&quot;localhost&quot;</span><span class="p">,</span> <span class="mi">25565</span><span class="p">)</span>
<span class="n">fastcs</span> <span class="o">=</span> <span class="n">FastCS</span><span class="p">(</span><span class="n">TemperatureController</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">connection_settings</span><span class="p">),</span> <span class="p">[</span><span class="n">epics_options</span><span class="p">])</span>

<span class="n">fastcs</span><span class="o">.</span><span class="n">create_gui</span><span class="p">()</span>

<span class="c1"># fastcs.run()  # Commented as this will block</span>
</pre></div>
</div>
</div>
<p>Now the temperature ramp can be run.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>❯<span class="w"> </span>caput<span class="w"> </span>DEMO:R1:Enabled<span class="w"> </span>On
Old<span class="w"> </span>:<span class="w"> </span>DEMO:R1:Enabled<span class="w">                </span>Off
New<span class="w"> </span>:<span class="w"> </span>DEMO:R1:Enabled<span class="w">                </span>On
❯<span class="w"> </span>caget<span class="w"> </span>DEMO:Power
DEMO:Power<span class="w">                     </span><span class="m">56</span>.84
❯<span class="w"> </span>caput<span class="w"> </span>DEMO:R1:Enabled<span class="w"> </span>Off
Old<span class="w"> </span>:<span class="w"> </span>DEMO:R1:Enabled<span class="w">                </span>On
New<span class="w"> </span>:<span class="w"> </span>DEMO:R1:Enabled<span class="w">                </span>Off
❯<span class="w"> </span>caget<span class="w"> </span>DEMO:Power
DEMO:Power<span class="w">                     </span><span class="m">0</span>
</pre></div>
</div>
<p>In the simulator terminal the progress of the ramp can be seen as it happens.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">INFO</span><span class="p">:</span><span class="n">fastcs</span><span class="o">.</span><span class="n">demo</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">device</span><span class="p">:</span><span class="n">Started</span> <span class="n">ramp</span> <span class="mi">0</span>
<span class="n">INFO</span><span class="p">:</span><span class="n">fastcs</span><span class="o">.</span><span class="n">demo</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">device</span><span class="p">:</span><span class="n">Target</span> <span class="n">Temperatures</span><span class="p">:</span> <span class="mf">10.000</span><span class="p">,</span> <span class="mf">0.000</span><span class="p">,</span> <span class="mf">0.000</span><span class="p">,</span> <span class="mf">0.000</span>
<span class="n">INFO</span><span class="p">:</span><span class="n">fastcs</span><span class="o">.</span><span class="n">demo</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">device</span><span class="p">:</span><span class="n">Actual</span> <span class="n">Temperatures</span><span class="p">:</span> <span class="mf">9.572</span><span class="p">,</span> <span class="mf">0.000</span><span class="p">,</span> <span class="mf">0.000</span><span class="p">,</span> <span class="mf">0.000</span>
<span class="n">INFO</span><span class="p">:</span><span class="n">fastcs</span><span class="o">.</span><span class="n">demo</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">device</span><span class="p">:</span><span class="n">Target</span> <span class="n">Temperatures</span><span class="p">:</span> <span class="mf">10.200</span><span class="p">,</span> <span class="mf">0.000</span><span class="p">,</span> <span class="mf">0.000</span><span class="p">,</span> <span class="mf">0.000</span>
<span class="n">INFO</span><span class="p">:</span><span class="n">fastcs</span><span class="o">.</span><span class="n">demo</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">device</span><span class="p">:</span><span class="n">Actual</span> <span class="n">Temperatures</span><span class="p">:</span> <span class="mf">9.952</span><span class="p">,</span> <span class="mf">0.000</span><span class="p">,</span> <span class="mf">0.000</span><span class="p">,</span> <span class="mf">0.000</span>
<span class="n">INFO</span><span class="p">:</span><span class="n">fastcs</span><span class="o">.</span><span class="n">demo</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">device</span><span class="p">:</span><span class="n">Target</span> <span class="n">Temperatures</span><span class="p">:</span> <span class="mf">10.400</span><span class="p">,</span> <span class="mf">0.000</span><span class="p">,</span> <span class="mf">0.000</span><span class="p">,</span> <span class="mf">0.000</span>
<span class="o">...</span>
<span class="n">INFO</span><span class="p">:</span><span class="n">fastcs</span><span class="o">.</span><span class="n">demo</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">device</span><span class="p">:</span><span class="n">Stopped</span> <span class="n">ramp</span> <span class="mi">0</span>
</pre></div>
</div>
<p>The target and actual temperatures visible in the simulator terminal are also exposed in
the API with the <code class="docutils literal notranslate"><span class="pre">T01?</span></code> and <code class="docutils literal notranslate"><span class="pre">A01?</span></code> commands.</p>
</section>
<section id="fastcs-methods">
<h2>FastCS Methods<a class="headerlink" href="#fastcs-methods" title="Link to this heading">#</a></h2>
<p>The applied voltage for each ramp is also available with the <code class="docutils literal notranslate"><span class="pre">V?</span></code> command, but the value
is an array with each element corresponding to a ramp. Here it will be simplest to
manually fetch the array in the parent controller and pass each value into ramp
controller. This can be done with a <code class="docutils literal notranslate"><span class="pre">scan</span></code> method - these are called at a defined rate,
similar to the <code class="docutils literal notranslate"><span class="pre">update</span></code> method of handlers.</p>
<p>Add an <code class="docutils literal notranslate"><span class="pre">AttrR</span></code> for the voltage to the <code class="docutils literal notranslate"><span class="pre">TemperatureRampController</span></code>, but do not pass it a
handler. Then add a method to the <code class="docutils literal notranslate"><span class="pre">TemperatureController</span></code> with a <code class="docutils literal notranslate"><span class="pre">&#64;scan</span></code> decorator that
gets the array of voltages and sets each ramp controller with its value. Also add
<code class="docutils literal notranslate"><span class="pre">AttrR</span></code>s for the target and actual temperature for each ramp as described above.</p>
<div class="dropdown hint admonition">
<p class="admonition-title">Code 12</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">enum</span>
<span class="hll"><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
</span><span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">fastcs.attributes</span><span class="w"> </span><span class="kn">import</span> <span class="n">AttrHandlerRW</span><span class="p">,</span> <span class="n">AttrR</span><span class="p">,</span> <span class="n">AttrRW</span><span class="p">,</span> <span class="n">AttrW</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastcs.connections</span><span class="w"> </span><span class="kn">import</span> <span class="n">IPConnection</span><span class="p">,</span> <span class="n">IPConnectionSettings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastcs.controller</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseController</span><span class="p">,</span> <span class="n">Controller</span><span class="p">,</span> <span class="n">SubController</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastcs.datatypes</span><span class="w"> </span><span class="kn">import</span> <span class="n">Enum</span><span class="p">,</span> <span class="n">Float</span><span class="p">,</span> <span class="n">Int</span><span class="p">,</span> <span class="n">String</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastcs.launch</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastCS</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastcs.transport.epics.ca.options</span><span class="w"> </span><span class="kn">import</span> <span class="n">EpicsCAOptions</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastcs.transport.epics.options</span><span class="w"> </span><span class="kn">import</span> <span class="n">EpicsGUIOptions</span><span class="p">,</span> <span class="n">EpicsIOCOptions</span>
<span class="hll"><span class="kn">from</span><span class="w"> </span><span class="nn">fastcs.wrappers</span><span class="w"> </span><span class="kn">import</span> <span class="n">scan</span>
</span>

<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">TemperatureControllerHandler</span><span class="p">(</span><span class="n">AttrHandlerRW</span><span class="p">):</span>
    <span class="n">command_name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">update_period</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="mf">0.2</span>
    <span class="n">_controller</span><span class="p">:</span> <span class="n">TemperatureController</span> <span class="o">|</span> <span class="n">TemperatureRampController</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">initialise</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">controller</span><span class="p">:</span> <span class="n">BaseController</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">controller</span><span class="p">,</span> <span class="n">TemperatureController</span> <span class="o">|</span> <span class="n">TemperatureRampController</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_controller</span> <span class="o">=</span> <span class="n">controller</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">controller</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TemperatureController</span> <span class="o">|</span> <span class="n">TemperatureRampController</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_controller</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Handler not initialised&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_controller</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">:</span> <span class="n">AttrR</span><span class="p">):</span>
        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">send_query</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">command_name</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">suffix</span><span class="si">}</span><span class="s2">?</span><span class="se">\r\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">await</span> <span class="n">attr</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">:</span> <span class="n">AttrW</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">send_command</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">command_name</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">suffix</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">attr</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="si">}</span><span class="se">\r\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">OnOffEnum</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">StrEnum</span><span class="p">):</span>
    <span class="n">Off</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span>
    <span class="n">On</span> <span class="o">=</span> <span class="s2">&quot;1&quot;</span>


<span class="k">class</span><span class="w"> </span><span class="nc">TemperatureRampController</span><span class="p">(</span><span class="n">SubController</span><span class="p">):</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">AttrRW</span><span class="p">(</span><span class="n">Int</span><span class="p">(),</span> <span class="n">handler</span><span class="o">=</span><span class="n">TemperatureControllerHandler</span><span class="p">(</span><span class="s2">&quot;S&quot;</span><span class="p">))</span>
    <span class="n">end</span> <span class="o">=</span> <span class="n">AttrRW</span><span class="p">(</span><span class="n">Int</span><span class="p">(),</span> <span class="n">handler</span><span class="o">=</span><span class="n">TemperatureControllerHandler</span><span class="p">(</span><span class="s2">&quot;E&quot;</span><span class="p">))</span>
    <span class="n">enabled</span> <span class="o">=</span> <span class="n">AttrRW</span><span class="p">(</span><span class="n">Enum</span><span class="p">(</span><span class="n">OnOffEnum</span><span class="p">),</span> <span class="n">handler</span><span class="o">=</span><span class="n">TemperatureControllerHandler</span><span class="p">(</span><span class="s2">&quot;N&quot;</span><span class="p">))</span>
<span class="hll">    <span class="n">target</span> <span class="o">=</span> <span class="n">AttrR</span><span class="p">(</span><span class="n">Float</span><span class="p">(),</span> <span class="n">handler</span><span class="o">=</span><span class="n">TemperatureControllerHandler</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">))</span>
</span><span class="hll">    <span class="n">actual</span> <span class="o">=</span> <span class="n">AttrR</span><span class="p">(</span><span class="n">Float</span><span class="p">(),</span> <span class="n">handler</span><span class="o">=</span><span class="n">TemperatureControllerHandler</span><span class="p">(</span><span class="s2">&quot;A&quot;</span><span class="p">))</span>
</span><span class="hll">    <span class="n">voltage</span> <span class="o">=</span> <span class="n">AttrR</span><span class="p">(</span><span class="n">Float</span><span class="p">())</span>
</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">connection</span><span class="p">:</span> <span class="n">IPConnection</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">index</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Ramp</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="n">connection</span>


<span class="k">class</span><span class="w"> </span><span class="nc">TemperatureController</span><span class="p">(</span><span class="n">Controller</span><span class="p">):</span>
    <span class="n">device_id</span> <span class="o">=</span> <span class="n">AttrR</span><span class="p">(</span><span class="n">String</span><span class="p">(),</span> <span class="n">handler</span><span class="o">=</span><span class="n">TemperatureControllerHandler</span><span class="p">(</span><span class="s2">&quot;ID&quot;</span><span class="p">))</span>
    <span class="n">power</span> <span class="o">=</span> <span class="n">AttrR</span><span class="p">(</span><span class="n">Float</span><span class="p">(),</span> <span class="n">handler</span><span class="o">=</span><span class="n">TemperatureControllerHandler</span><span class="p">(</span><span class="s2">&quot;P&quot;</span><span class="p">))</span>
    <span class="n">ramp_rate</span> <span class="o">=</span> <span class="n">AttrRW</span><span class="p">(</span><span class="n">Float</span><span class="p">(),</span> <span class="n">handler</span><span class="o">=</span><span class="n">TemperatureControllerHandler</span><span class="p">(</span><span class="s2">&quot;R&quot;</span><span class="p">))</span>

    <span class="n">suffix</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ramp_count</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">settings</span><span class="p">:</span> <span class="n">IPConnectionSettings</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ip_settings</span> <span class="o">=</span> <span class="n">settings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="n">IPConnection</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ramp_controllers</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">TemperatureRampController</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ramp_count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">ramp_controller</span> <span class="o">=</span> <span class="n">TemperatureRampController</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ramp_controllers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ramp_controller</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">register_sub_controller</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;R</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ramp_controller</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ip_settings</span><span class="p">)</span>

<span class="hll">    <span class="nd">@scan</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
</span><span class="hll">    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">update_voltages</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class="hll">        <span class="n">voltages</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span>
</span><span class="hll">            <span class="p">(</span><span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">send_query</span><span class="p">(</span><span class="s2">&quot;V?</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class="hll">        <span class="p">)</span>
</span><span class="hll">        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">controller</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ramp_controllers</span><span class="p">):</span>
</span><span class="hll">            <span class="k">await</span> <span class="n">controller</span><span class="o">.</span><span class="n">voltage</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">voltages</span><span class="p">[</span><span class="n">index</span><span class="p">]))</span>
</span>

<span class="n">gui_options</span> <span class="o">=</span> <span class="n">EpicsGUIOptions</span><span class="p">(</span>
    <span class="n">output_path</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;demo.bob&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Demo Temperature Controller&quot;</span>
<span class="p">)</span>
<span class="n">epics_options</span> <span class="o">=</span> <span class="n">EpicsCAOptions</span><span class="p">(</span>
    <span class="n">gui</span><span class="o">=</span><span class="n">gui_options</span><span class="p">,</span>
    <span class="n">ca_ioc</span><span class="o">=</span><span class="n">EpicsIOCOptions</span><span class="p">(</span><span class="n">pv_prefix</span><span class="o">=</span><span class="s2">&quot;DEMO&quot;</span><span class="p">),</span>
<span class="p">)</span>
<span class="n">connection_settings</span> <span class="o">=</span> <span class="n">IPConnectionSettings</span><span class="p">(</span><span class="s2">&quot;localhost&quot;</span><span class="p">,</span> <span class="mi">25565</span><span class="p">)</span>
<span class="n">fastcs</span> <span class="o">=</span> <span class="n">FastCS</span><span class="p">(</span><span class="n">TemperatureController</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">connection_settings</span><span class="p">),</span> <span class="p">[</span><span class="n">epics_options</span><span class="p">])</span>

<span class="n">fastcs</span><span class="o">.</span><span class="n">create_gui</span><span class="p">()</span>

<span class="c1"># fastcs.run()  # Commented as this will block</span>
</pre></div>
</div>
</div>
<p>Creating attributes is intended to be a simple API covering most use cases, but where
more flexibility is needed wrapped controller methods can be useful to avoid adding
complexity to the handlers to handle a small subset of attributes. It is also useful for
implementing higher level logic on top of the attributes that expose the API of a device
directly. For example, it would be useful to have a single button to stop all of the
ramps at the same time. This can be done with a <code class="docutils literal notranslate"><span class="pre">command</span></code> method. These are similar to
<code class="docutils literal notranslate"><span class="pre">scan</span></code> methods except that they create an API in transport layer in the same way an
attribute does.</p>
<p>Add a method with a <code class="docutils literal notranslate"><span class="pre">&#64;command</span></code> decorator to set enabled to false in every ramp
controller.</p>
<div class="dropdown hint admonition">
<p class="admonition-title">Code 13</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>

<span class="hll"><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
</span><span class="kn">import</span><span class="w"> </span><span class="nn">enum</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">fastcs.attributes</span><span class="w"> </span><span class="kn">import</span> <span class="n">AttrHandlerRW</span><span class="p">,</span> <span class="n">AttrR</span><span class="p">,</span> <span class="n">AttrRW</span><span class="p">,</span> <span class="n">AttrW</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastcs.connections</span><span class="w"> </span><span class="kn">import</span> <span class="n">IPConnection</span><span class="p">,</span> <span class="n">IPConnectionSettings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastcs.controller</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseController</span><span class="p">,</span> <span class="n">Controller</span><span class="p">,</span> <span class="n">SubController</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastcs.datatypes</span><span class="w"> </span><span class="kn">import</span> <span class="n">Enum</span><span class="p">,</span> <span class="n">Float</span><span class="p">,</span> <span class="n">Int</span><span class="p">,</span> <span class="n">String</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastcs.launch</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastCS</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastcs.transport.epics.ca.options</span><span class="w"> </span><span class="kn">import</span> <span class="n">EpicsCAOptions</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastcs.transport.epics.options</span><span class="w"> </span><span class="kn">import</span> <span class="n">EpicsGUIOptions</span><span class="p">,</span> <span class="n">EpicsIOCOptions</span>
<span class="hll"><span class="kn">from</span><span class="w"> </span><span class="nn">fastcs.wrappers</span><span class="w"> </span><span class="kn">import</span> <span class="n">command</span><span class="p">,</span> <span class="n">scan</span>
</span>

<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">TemperatureControllerHandler</span><span class="p">(</span><span class="n">AttrHandlerRW</span><span class="p">):</span>
    <span class="n">command_name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">update_period</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="mf">0.2</span>
    <span class="n">_controller</span><span class="p">:</span> <span class="n">TemperatureController</span> <span class="o">|</span> <span class="n">TemperatureRampController</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">initialise</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">controller</span><span class="p">:</span> <span class="n">BaseController</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">controller</span><span class="p">,</span> <span class="n">TemperatureController</span> <span class="o">|</span> <span class="n">TemperatureRampController</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_controller</span> <span class="o">=</span> <span class="n">controller</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">controller</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TemperatureController</span> <span class="o">|</span> <span class="n">TemperatureRampController</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_controller</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Handler not initialised&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_controller</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">:</span> <span class="n">AttrR</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">send_query</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">command_name</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">suffix</span><span class="si">}</span><span class="s2">?</span><span class="se">\r\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">await</span> <span class="n">attr</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">:</span> <span class="n">AttrW</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">send_command</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">command_name</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">suffix</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">attr</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="si">}</span><span class="se">\r\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">OnOffEnum</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">StrEnum</span><span class="p">):</span>
    <span class="n">Off</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span>
    <span class="n">On</span> <span class="o">=</span> <span class="s2">&quot;1&quot;</span>


<span class="k">class</span><span class="w"> </span><span class="nc">TemperatureRampController</span><span class="p">(</span><span class="n">SubController</span><span class="p">):</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">AttrRW</span><span class="p">(</span><span class="n">Int</span><span class="p">(),</span> <span class="n">handler</span><span class="o">=</span><span class="n">TemperatureControllerHandler</span><span class="p">(</span><span class="s2">&quot;S&quot;</span><span class="p">))</span>
    <span class="n">end</span> <span class="o">=</span> <span class="n">AttrRW</span><span class="p">(</span><span class="n">Int</span><span class="p">(),</span> <span class="n">handler</span><span class="o">=</span><span class="n">TemperatureControllerHandler</span><span class="p">(</span><span class="s2">&quot;E&quot;</span><span class="p">))</span>
    <span class="n">enabled</span> <span class="o">=</span> <span class="n">AttrRW</span><span class="p">(</span><span class="n">Enum</span><span class="p">(</span><span class="n">OnOffEnum</span><span class="p">),</span> <span class="n">handler</span><span class="o">=</span><span class="n">TemperatureControllerHandler</span><span class="p">(</span><span class="s2">&quot;N&quot;</span><span class="p">))</span>
    <span class="n">target</span> <span class="o">=</span> <span class="n">AttrR</span><span class="p">(</span><span class="n">Float</span><span class="p">(),</span> <span class="n">handler</span><span class="o">=</span><span class="n">TemperatureControllerHandler</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">))</span>
    <span class="n">actual</span> <span class="o">=</span> <span class="n">AttrR</span><span class="p">(</span><span class="n">Float</span><span class="p">(),</span> <span class="n">handler</span><span class="o">=</span><span class="n">TemperatureControllerHandler</span><span class="p">(</span><span class="s2">&quot;A&quot;</span><span class="p">))</span>
    <span class="n">voltage</span> <span class="o">=</span> <span class="n">AttrR</span><span class="p">(</span><span class="n">Float</span><span class="p">())</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">connection</span><span class="p">:</span> <span class="n">IPConnection</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">index</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Ramp</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="n">connection</span>


<span class="k">class</span><span class="w"> </span><span class="nc">TemperatureController</span><span class="p">(</span><span class="n">Controller</span><span class="p">):</span>
    <span class="n">device_id</span> <span class="o">=</span> <span class="n">AttrR</span><span class="p">(</span><span class="n">String</span><span class="p">(),</span> <span class="n">handler</span><span class="o">=</span><span class="n">TemperatureControllerHandler</span><span class="p">(</span><span class="s2">&quot;ID&quot;</span><span class="p">))</span>
    <span class="n">power</span> <span class="o">=</span> <span class="n">AttrR</span><span class="p">(</span><span class="n">Float</span><span class="p">(),</span> <span class="n">handler</span><span class="o">=</span><span class="n">TemperatureControllerHandler</span><span class="p">(</span><span class="s2">&quot;P&quot;</span><span class="p">))</span>
    <span class="n">ramp_rate</span> <span class="o">=</span> <span class="n">AttrRW</span><span class="p">(</span><span class="n">Float</span><span class="p">(),</span> <span class="n">handler</span><span class="o">=</span><span class="n">TemperatureControllerHandler</span><span class="p">(</span><span class="s2">&quot;R&quot;</span><span class="p">))</span>

    <span class="n">suffix</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ramp_count</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">settings</span><span class="p">:</span> <span class="n">IPConnectionSettings</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ip_settings</span> <span class="o">=</span> <span class="n">settings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="n">IPConnection</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ramp_controllers</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">TemperatureRampController</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ramp_count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">ramp_controller</span> <span class="o">=</span> <span class="n">TemperatureRampController</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ramp_controllers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ramp_controller</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">register_sub_controller</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;R</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ramp_controller</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ip_settings</span><span class="p">)</span>

    <span class="nd">@scan</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">update_voltages</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">voltages</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span>
            <span class="p">(</span><span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">send_query</span><span class="p">(</span><span class="s2">&quot;V?</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">controller</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ramp_controllers</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">controller</span><span class="o">.</span><span class="n">voltage</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">voltages</span><span class="p">[</span><span class="n">index</span><span class="p">]))</span>

<span class="hll">    <span class="nd">@command</span><span class="p">()</span>
</span><span class="hll">    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">disable_all</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span class="hll">        <span class="k">for</span> <span class="n">rc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ramp_controllers</span><span class="p">:</span>
</span><span class="hll">            <span class="k">await</span> <span class="n">rc</span><span class="o">.</span><span class="n">enabled</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">OnOffEnum</span><span class="o">.</span><span class="n">Off</span><span class="p">)</span>
</span><span class="hll">            <span class="c1"># TODO: The requests all get concatenated and the sim doesn&#39;t handle it</span>
</span><span class="hll">            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
</span><span class="hll">
</span>
<span class="n">gui_options</span> <span class="o">=</span> <span class="n">EpicsGUIOptions</span><span class="p">(</span>
    <span class="n">output_path</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;demo.bob&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Demo Temperature Controller&quot;</span>
<span class="p">)</span>
<span class="n">epics_options</span> <span class="o">=</span> <span class="n">EpicsCAOptions</span><span class="p">(</span>
    <span class="n">gui</span><span class="o">=</span><span class="n">gui_options</span><span class="p">,</span>
    <span class="n">ca_ioc</span><span class="o">=</span><span class="n">EpicsIOCOptions</span><span class="p">(</span><span class="n">pv_prefix</span><span class="o">=</span><span class="s2">&quot;DEMO&quot;</span><span class="p">),</span>
<span class="p">)</span>
<span class="n">connection_settings</span> <span class="o">=</span> <span class="n">IPConnectionSettings</span><span class="p">(</span><span class="s2">&quot;localhost&quot;</span><span class="p">,</span> <span class="mi">25565</span><span class="p">)</span>
<span class="n">fastcs</span> <span class="o">=</span> <span class="n">FastCS</span><span class="p">(</span><span class="n">TemperatureController</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">connection_settings</span><span class="p">),</span> <span class="p">[</span><span class="n">epics_options</span><span class="p">])</span>

<span class="n">fastcs</span><span class="o">.</span><span class="n">create_gui</span><span class="p">()</span>

<span class="c1"># fastcs.run()  # Commented as this will block</span>
</pre></div>
</div>
</div>
<p>The new <code class="docutils literal notranslate"><span class="pre">DEMO:CancelAll</span></code> PV can be set (the value doesn’t matter) to stop all of the
ramps.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>❯ caget DEMO:R1:Enabled_RBV
DEMO:R1:Enabled_RBV            On
❯ caput DEMO:DisableAll 1
Old : DEMO:DisableAll
New : DEMO:DisableAll
❯ caget DEMO:R1:Enabled_RBV
DEMO:R1:Enabled_RBV            Off
</pre></div>
</div>
</section>
<section id="summary">
<h2>Summary<a class="headerlink" href="#summary" title="Link to this heading">#</a></h2>
<p>This demonstrates some of the simple use cases for a statically defined FastCS driver.
It is also possible to instantiate a driver dynamically by instantiating a device during
startup. See the next tutorial for how to do this (TODO).</p>
</section>
</section>


                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="installation.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Installation</p>
      </div>
    </a>
    <a class="right-next"
       href="../how-to.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">How-to Guides</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
<div
    id="pst-page-navigation-heading-2"
    class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc" aria-labelledby="pst-page-navigation-heading-2">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#demo-simulation">Demo Simulation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#fastcs-controllers">FastCS Controllers</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#fastcs-launcher">FastCS Launcher</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#fastcs-attributes">FastCS Attributes</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#fastcs-transports">FastCS Transports</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#fastcs-device-connection">FastCS Device Connection</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#building-up-the-api">Building Up The API</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#fastcs-methods">FastCS Methods</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#summary">Summary</a></li>
</ul>
  </nav></div>

  <div class="sidebar-secondary-item">

  
  <div class="tocsection editthispage">
    <a href="https://github.com/DiamondLightSource/FastCS/edit/0.9.2a3/docs/tutorials/static-drivers.md">
      <i class="fa-solid fa-pencil"></i>
      
      
        
          Edit on GitHub
        
      
    </a>
  </div>
</div>

  <div class="sidebar-secondary-item">
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/tutorials/static-drivers.md.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  <!-- # L10n: Setting the PST URL as an argument as this does not need to be localized -->
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.16.1.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>